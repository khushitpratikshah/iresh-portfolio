import React, { useState, useEffect, useRef } from 'react';
import { 
  motion, 
  useScroll, 
  useSpring, 
  useMotionValue, 
  useMotionTemplate, 
  AnimatePresence
} from 'framer-motion';
import { 
  ArrowRight, 
  Terminal as TerminalIcon, 
  Trophy, 
  Cpu, 
  Activity, 
  Globe, 
  Mail, 
  Github, 
  Menu, 
  X,
  Zap,
  ChevronRight,
  Music,
  Box
} from 'lucide-react';

// --- GLOBAL STYLES (Scrollbar & Selection) ---
const GlobalStyles = () => (
  <style>{`
    ::-webkit-scrollbar {
      width: 10px;
    }
    ::-webkit-scrollbar-track {
      background: #020617; 
    }
    ::-webkit-scrollbar-thumb {
      background: #1e293b; 
      border-radius: 5px;
      border: 2px solid #020617;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #334155; 
    }
    ::selection {
      background: rgba(34, 211, 238, 0.2);
      color: #bae6fd;
    }
  `}</style>
);

// --- CONFIG & DATA ---
const skills = [
  "C++ SYSTEMS", "PYTHON", "FULL STACK", "REACT.JS", 
  "JAVASCRIPT", "ALGORITHMS", "HTML/CSS", "COMPETITIVE TENNIS"
];

const achievements = [
  {
    title: "Technothlon IIT Guwahati",
    subtitle: "AIR 4 (Mains) / AIR 20 (Prelims)",
    desc: "Invited to IIT Guwahati. Competed against the top young minds in India in logic and creativity.",
    icon: <Cpu className="text-cyan-400" size={32} />,
    size: "large",
    gradient: "from-cyan-900/40 to-blue-900/40"
  },
  {
    title: "National Tennis",
    subtitle: "Top Ranked U-14",
    desc: "Gujarat's leading player. Balancing physical endurance with computational logic.",
    icon: <Activity className="text-lime-400" size={32} />,
    size: "normal",
    gradient: "from-green-900/40 to-emerald-900/40"
  },
  {
    title: "UK 11+ Scholarship",
    subtitle: "Rank 1 Essex County",
    desc: "100% Scholarship to Westcliff High School for Boys (UK). Academic excellence across borders.",
    icon: <Globe className="text-purple-400" size={32} />,
    size: "normal",
    gradient: "from-purple-900/40 to-indigo-900/40"
  },
  {
    title: "BOB Olympiad",
    subtitle: "AIR 1 Gold Medalist",
    desc: "National level distinction in academic excellence, securing the top rank amongst thousands.",
    icon: <Trophy className="text-yellow-400" size={32} />,
    size: "wide",
    gradient: "from-yellow-900/20 to-orange-900/20"
  }
];

const projects = [
  {
    id: "01",
    title: "Physics Sandbox Engine",
    tech: "C++ / Wasm",
    desc: "A custom 2D physics engine emphasizing collision detection and memory optimization.",
    statLabel: "Frame Rate",
    stat: "60 FPS",
    icon: <Box />
  },
  {
    id: "02",
    title: "Algorithm Tournament",
    tech: "Python / React",
    desc: "Visualizer for sorting algorithms competing against each other in real-time brackets.",
    statLabel: "Complexity",
    stat: "O(n log n)",
    icon: <Zap />
  },
  {
    id: "03",
    title: "Tennis Shot Heatmap",
    tech: "Data Viz / D3",
    desc: "Analyzing match data to plot shot placement probability densities on a court grid.",
    statLabel: "Accuracy",
    stat: "98%",
    icon: <Activity />
  }
];

// --- COMPONENTS ---

const NoiseOverlay = () => (
  <div className="fixed inset-0 pointer-events-none z-50 opacity-[0.03] mix-blend-overlay">
    <svg className='w-full h-full'>
      <filter id='noiseFilter'>
        <feTurbulence type='fractalNoise' baseFrequency='0.8' stitchTiles='stitch' />
      </filter>
      <rect width='100%' height='100%' filter='url(#noiseFilter)' />
    </svg>
  </div>
);

const Marquee = () => {
  return (
    <div className="relative flex overflow-hidden py-4 md:py-6 bg-slate-900/50 border-y border-white/5 backdrop-blur-sm w-full group">
      <div className="absolute inset-0 z-10 bg-gradient-to-r from-slate-950 via-transparent to-slate-950 pointer-events-none" />
      <motion.div 
        className="flex gap-16 whitespace-nowrap items-center"
        animate={{ x: "-50%" }}
        transition={{ repeat: Infinity, ease: "linear", duration: 30 }}
      >
        {[...skills, ...skills, ...skills, ...skills].map((item, i) => (
          <div key={i} className="flex items-center gap-4 text-xl md:text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white/70 to-white/30 uppercase tracking-tighter group-hover:opacity-100 transition-opacity">
            {item} <span className="text-cyan-500 text-sm md:text-lg">‚óè</span>
          </div>
        ))}
      </motion.div>
    </div>
  );
};

const MagneticButton = ({ children, className, onClick }) => {
  const ref = useRef(null);
  const [position, setPosition] = useState({ x: 0, y: 0 });

  const handleMouse = (e) => {
    const { clientX, clientY } = e;
    const { height, width, left, top } = ref.current.getBoundingClientRect();
    const middleX = clientX - (left + width / 2);
    const middleY = clientY - (top + height / 2);
    setPosition({ x: middleX * 0.2, y: middleY * 0.2 });
  };

  const reset = () => setPosition({ x: 0, y: 0 });

  return (
    <motion.button
      ref={ref}
      onClick={onClick}
      onMouseMove={handleMouse}
      onMouseLeave={reset}
      animate={{ x: position.x, y: position.y }}
      transition={{ type: "spring", stiffness: 150, damping: 15, mass: 0.1 }}
      className={className}
    >
      {children}
    </motion.button>
  );
};

const SpotlightCard = ({ children, className = "", gradient }) => {
  const mouseX = useMotionValue(0);
  const mouseY = useMotionValue(0);

  function handleMouseMove({ currentTarget, clientX, clientY }) {
    const { left, top } = currentTarget.getBoundingClientRect();
    mouseX.set(clientX - left);
    mouseY.set(clientY - top);
  }

  return (
    <motion.div
      whileHover={{ y: -5 }}
      transition={{ type: "spring", stiffness: 300, damping: 20 }}
      className={`group relative border border-white/10 bg-slate-900/40 overflow-hidden rounded-3xl ${className}`}
      onMouseMove={handleMouseMove}
    >
      <motion.div
        className="pointer-events-none absolute -inset-px rounded-3xl opacity-0 transition duration-300 group-hover:opacity-100"
        style={{
          background: useMotionTemplate`
            radial-gradient(
              650px circle at ${mouseX}px ${mouseY}px,
              rgba(34, 211, 238, 0.1),
              transparent 80%
            )
          `,
        }}
      />
      <div className={`relative h-full bg-gradient-to-br ${gradient} p-6 md:p-8 flex flex-col justify-between`}>
        {children}
      </div>
    </motion.div>
  );
};

const Terminal = () => {
  const [input, setInput] = useState("");
  const [history, setHistory] = useState([
    { type: 'output', content: 'Welcome to IreshOS v2.1.0' },
    { type: 'output', content: 'Type "help" to see what I can do.' }
  ]);
  const inputRef = useRef(null);
  const terminalBodyRef = useRef(null);

  useEffect(() => {
    if (terminalBodyRef.current && history.length > 2) {
      terminalBodyRef.current.scrollTo({
        top: terminalBodyRef.current.scrollHeight,
        behavior: 'smooth'
      });
    }
  }, [history]);

  const handleCommand = (e) => {
    if (e.key === 'Enter') {
      const cmd = input.trim().toLowerCase();
      let response = "";
      
      switch(cmd) {
        case 'help':
          response = "Commands: stack, about, projects, contact, clear";
          break;
        case 'stack':
          response = "Learning: C++, Python, React, JS, HTML/CSS.";
          break;
        case 'about':
          response = "Iresh Tilva: 13yo Student, Coder, Tennis Player.";
          break;
        case 'projects':
          response = "1. Physics Engine (C++)  2. Algo Visualizer";
          break;
        case 'contact':
          response = "Opening mail client...";
          window.location.href = "mailto:hello@ireshtilva.com";
          break;
        case 'clear':
          setHistory([]);
          setInput("");
          return;
        default:
          response = `Command not found: ${cmd}`;
      }
      
      setHistory(prev => [...prev, { type: 'input', content: input }, { type: 'output', content: response }]);
      setInput("");
    }
  };

  return (
    <div className="w-full max-w-2xl mx-auto mt-12 font-mono text-sm bg-black/80 rounded-lg border border-white/10 shadow-2xl overflow-hidden backdrop-blur-md transform-none group transition-all duration-300 hover:border-white/20 hover:shadow-cyan-500/10">
      <div className="flex items-center gap-2 px-4 py-2 bg-white/5 border-b border-white/5">
        <div className="w-3 h-3 rounded-full bg-red-500/80" />
        <div className="w-3 h-3 rounded-full bg-yellow-500/80" />
        <div className="w-3 h-3 rounded-full bg-green-500/80" />
        <span className="ml-2 text-xs text-slate-500">guest@ireshtilva:~</span>
      </div>
      <div 
        ref={terminalBodyRef}
        className="p-4 h-64 overflow-y-auto cursor-text scrollbar-thin scrollbar-thumb-white/10 scrollbar-track-transparent" 
        onClick={() => inputRef.current?.focus()}
      >
        {history.map((line, i) => (
          <div key={i} className={`mb-1 ${line.type === 'input' ? 'text-cyan-400' : 'text-slate-300'}`}>
            {line.type === 'input' ? '> ' : ''}{line.content}
          </div>
        ))}
        <div className="flex items-center text-cyan-400">
          <span className="mr-2">{'>'}</span>
          <input 
            ref={inputRef}
            type="text" 
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyDown={handleCommand}
            className="flex-1 bg-transparent outline-none border-none text-cyan-400 placeholder-slate-600 min-w-0"
            autoFocus
          />
        </div>
      </div>
    </div>
  );
};

const ScrollIndicator = () => (
  <motion.div 
    initial={{ opacity: 0 }}
    animate={{ opacity: 1 }}
    transition={{ delay: 1, duration: 1 }}
    className="absolute bottom-8 left-1/2 -translate-x-1/2 flex flex-col items-center gap-2 text-slate-500"
  >
    <span className="text-[10px] uppercase tracking-widest">Scroll</span>
    <motion.div 
      animate={{ y: [0, 5, 0] }}
      transition={{ repeat: Infinity, duration: 1.5, ease: "easeInOut" }}
    >
      <ArrowRight className="rotate-90 w-4 h-4" />
    </motion.div>
  </motion.div>
);

// --- HERO COMPONENT ---
const Hero = () => {
  return (
    <div className="relative z-10 max-w-5xl mx-auto text-center px-2 sm:px-4">
      <motion.div
        initial={{ opacity: 0, y: 50 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 1, ease: [0.22, 1, 0.36, 1] }}
      >
        <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-white/10 bg-white/5 text-cyan-400 text-xs font-bold tracking-wider mb-8 uppercase hover:bg-white/10 transition-colors cursor-default">
          <span className="relative flex h-2 w-2">
            <span className="animate-ping absolute inline-flex h-full w-full rounded-full opacity-75 bg-cyan-400"></span>
            <span className="relative inline-flex rounded-full h-2 w-2 bg-cyan-500"></span>
          </span>
          Student & Developer
        </div>
        
        <h1 className="text-4xl sm:text-7xl md:text-9xl font-black tracking-tighter leading-[1.0] sm:leading-[0.9] mb-8 text-white relative">
           {/* Ambient Glow behind text */}
          <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3/4 h-3/4 bg-cyan-500/20 blur-[100px] rounded-full pointer-events-none -z-10" />
          
          <span className="block sm:inline">CODE.</span>{" "}
          <span className="block sm:inline text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600">CREATE.</span>
          <span className="block sm:mt-2 hover:scale-105 transition-transform duration-500 cursor-default">CONQUER.</span>
        </h1>
        
        <p className="text-lg sm:text-xl md:text-2xl text-slate-400 max-w-2xl mx-auto mb-12 leading-relaxed font-light px-2 sm:px-4">
          I am <span className="text-white font-medium">Iresh Tilva</span>. A 13-year-old developer, national athlete, and future engineer. I build cool things with <span className="text-cyan-400">C++</span> and <span className="text-cyan-400">Web Tech</span>.
        </p>

        <Terminal />
      </motion.div>
    </div>
  );
};

const SpotifyWidget = () => (
  <div className="flex items-center gap-3 px-4 py-2 bg-black/40 backdrop-blur-md rounded-full border border-white/5 animate-fade-in hover:border-white/10 transition-colors cursor-default">
    <div className="relative w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center">
       <Music size={14} className="text-green-500" />
       {/* Fake equalizer bars */}
       <div className="absolute bottom-1 left-2 flex gap-0.5 items-end h-3">
         <motion.div animate={{ height: [4, 8, 4] }} transition={{ repeat: Infinity, duration: 0.5 }} className="w-0.5 bg-green-500 rounded-full" />
         <motion.div animate={{ height: [6, 10, 5] }} transition={{ repeat: Infinity, duration: 0.4, delay: 0.1 }} className="w-0.5 bg-green-500 rounded-full" />
         <motion.div animate={{ height: [3, 7, 3] }} transition={{ repeat: Infinity, duration: 0.6, delay: 0.2 }} className="w-0.5 bg-green-500 rounded-full" />
       </div>
    </div>
    <div className="text-left">
      <div className="text-[10px] text-slate-400 uppercase tracking-wider font-bold">Now Playing</div>
      <div className="text-xs text-white truncate max-w-[100px] font-medium">Deep Focus flow</div>
    </div>
  </div>
);

// --- MAIN PAGE ---
export default function Portfolio() {
  const { scrollYProgress } = useScroll();
  const scaleX = useSpring(scrollYProgress, { stiffness: 100, damping: 30, restDelta: 0.001 });
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  useEffect(() => {
    window.scrollTo(0, 0);
  }, []);

  useEffect(() => {
    const style = 'background: #0f172a; color: #22d3ee; font-size: 16px; padding: 10px; border-radius: 4px; font-weight: bold; border: 1px solid #22d3ee; font-family: monospace;';
    const subStyle = 'color: #94a3b8; font-size: 12px; font-family: sans-serif;';
    console.log('%c Hello! üöÄ', style);
    console.log('%c Engineered by Iresh Tilva.', subStyle);
  }, []);

  return (
    <div className="bg-slate-950 min-h-screen w-full text-slate-200 selection:bg-cyan-500/30 selection:text-cyan-100 font-sans overflow-x-hidden">
      <GlobalStyles />
      <NoiseOverlay />
      
      {/* Scroll Progress Bar */}
      <motion.div className="fixed top-0 left-0 right-0 h-1 bg-gradient-to-r from-cyan-400 to-blue-600 origin-left z-50" style={{ scaleX }} />

      {/* NAVBAR */}
      <nav className="fixed top-0 left-0 w-full z-40 px-6 py-6 transition-all duration-300 backdrop-blur-md border-b border-white/5">
        <div className="max-w-7xl mx-auto flex justify-between items-center">
          <a href="#" className="text-xl font-bold tracking-tighter text-white flex items-center gap-2 group">
            <div className="w-8 h-8 bg-cyan-500 rounded-lg flex items-center justify-center text-slate-950 group-hover:rotate-12 transition-transform">
              <TerminalIcon size={18} strokeWidth={3} />
            </div>
            IRESH TILVA
          </a>
          
          <div className="hidden md:flex gap-8 text-sm font-medium text-slate-400 items-center">
            {['About', 'Achievements', 'Projects', 'Contact'].map((item) => (
              <a key={item} href={`#${item.toLowerCase()}`} className="hover:text-white transition-colors relative group">
                {item}
                <span className="absolute -bottom-1 left-0 w-0 h-px bg-cyan-500 transition-all group-hover:w-full" />
              </a>
            ))}
            <MagneticButton className="px-5 py-2 rounded-full border border-white/20 text-sm font-semibold bg-white/5 hover:bg-white hover:text-black transition-colors">
              Resume.pdf
            </MagneticButton>
          </div>

          <button className="md:hidden p-2 text-white" onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}>
            {isMobileMenuOpen ? <X size={24}/> : <Menu size={24} />}
          </button>
        </div>
      </nav>

      {/* Mobile Menu */}
      <AnimatePresence>
        {isMobileMenuOpen && (
          <motion.div
            initial={{ opacity: 0, y: -20, filter: 'blur(10px)' }}
            animate={{ opacity: 1, y: 0, filter: 'blur(0px)' }}
            exit={{ opacity: 0, y: -20, filter: 'blur(10px)' }}
            className="fixed inset-0 z-30 bg-slate-950/95 backdrop-blur-xl flex flex-col items-center justify-center space-y-8 md:hidden"
          >
            {['About', 'Achievements', 'Projects', 'Contact'].map((item, i) => (
               <motion.a 
                 key={item} 
                 initial={{ opacity: 0, x: -50 }}
                 animate={{ opacity: 1, x: 0 }}
                 transition={{ delay: i * 0.1 }}
                 onClick={() => setIsMobileMenuOpen(false)} 
                 href={`#${item.toLowerCase()}`} 
                 className="text-4xl font-bold text-white hover:text-cyan-400"
                >
                  {item}
               </motion.a>
            ))}
          </motion.div>
        )}
      </AnimatePresence>

      {/* HERO SECTION */}
      <section className="relative pt-32 pb-20 md:pt-48 md:pb-20 px-6 min-h-screen flex flex-col justify-center items-center text-center overflow-hidden">
        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[300px] md:w-[800px] h-[300px] md:h-[600px] bg-cyan-500/20 rounded-full blur-[80px] md:blur-[120px] pointer-events-none mix-blend-screen" />
        
        <Hero />
        <ScrollIndicator />
      </section>

      <Marquee />

      {/* ABOUT SECTION */}
      <section id="about" className="py-20 md:py-32 px-6">
        <div className="max-w-7xl mx-auto grid lg:grid-cols-2 gap-12 lg:gap-20 items-center">
          {/* Column 1: Authentic Bio */}
          <div className="order-1">
            <h2 className="text-3xl md:text-5xl lg:text-6xl font-bold tracking-tighter mb-6 text-white leading-tight">
              Code. Tennis. <br/>
              <span className="text-slate-600">Logic.</span>
            </h2>
            <div className="space-y-6 text-base md:text-lg text-slate-400 leading-relaxed">
              <p>
                I love turning complex logic into working apps. Whether it's analyzing a tennis game or optimizing C++ memory, I'm always trying to figure out how things work.
              </p>
              <p>
                I balance intense training on the court with coding late into the night. From <strong className="text-white">Westcliff High (UK)</strong> to logic competitions like <strong className="text-white">IIT Technothlon</strong>, I'm always learning.
              </p>
              <p className="text-sm font-mono text-cyan-500">
                // Favorites: C++, React, Math
              </p>
            </div>
          </div>
          
          {/* Column 2: Stats Grid */}
          <div className="order-2 grid grid-cols-2 gap-6 md:gap-8">
            {[
              { label: "Years Coding", val: "4+" },
              { label: "Olympiad Rank", val: "#1" },
              { label: "Languages", val: "5" },
              { label: "Cool Projects", val: "10+" }
            ].map((stat, i) => (
              <div key={i} className="group bg-slate-900/50 border-l-2 border-cyan-500/30 hover:border-cyan-500 p-6 transition-all hover:bg-slate-900 hover:shadow-lg hover:shadow-cyan-500/5">
                <div className="text-3xl md:text-4xl font-bold text-white mb-2 group-hover:scale-110 transition-transform origin-left">{stat.val}</div>
                <div className="text-xs md:text-sm text-slate-500 uppercase tracking-wider font-semibold">{stat.label}</div>
              </div>
            ))}
          </div>
        </div>
      </section>

      {/* AC